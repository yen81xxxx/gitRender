document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: ''
        },
        selectable: true,
        unselectAuto: false, // ğŸ”¥ ç¢ºä¿é»æ“Šäº‹ä»¶å¾Œä»å¯é¸å–æ—¥æœŸ
        select: function (info) {
            console.log('ğŸ“Œ Select event triggered', info); // ğŸ” Debug: ç¢ºä¿æœ‰è§¸ç™¼

            const startDate = info.startStr;
            let endDate = new Date(info.endStr);

            // ğŸ”¥ ä¿®æ­£ `endDate` è¨ˆç®—ï¼Œç¢ºä¿ `start` å’Œ `end` ä¸æœƒè®ŠæˆåŒä¸€å¤©
            const adjustedEndDate = new Date(endDate.getTime() - 1000 * 60 * 60 * 24).toISOString().split('T')[0];

            Swal.fire({
                title: 'æ–°å¢æ´»å‹•',
                html: `æ‚¨é¸æ“‡çš„ç¯„åœï¼š<br><strong>${startDate}</strong> åˆ° <strong>${adjustedEndDate}</strong>
                <br>
                <label>è«‹é¸æ“‡é¡è‰²ï¼š</label><br>
                <input type="radio" id="red" name="color" value="#FFA500" checked>
                <label for="red">æ©˜è‰²</label><br>
                <input type="radio" id="green" name="color" value="#98FF98">
                <label for="green">ç¶ è‰²</label><br>
                <input type="radio" id="blue" name="color" value="#89CFF0">
                <label for="blue">è—è‰²</label><br>
                `,
                input: 'text',
                inputPlaceholder: 'è«‹è¼¸å…¥æ´»å‹•å…§å®¹',
                showCancelButton: true,
                confirmButtonText: 'ç¢ºå®š',
                cancelButtonText: 'å–æ¶ˆ',
                preConfirm: function (eventContent) {
                    const color = document.querySelector('input[name="color"]:checked').value;
                    if (eventContent) {
                        return fetch('/events', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                InputContent: eventContent,
                                InputStartDate: startDate,
                                InputEndDate: adjustedEndDate,
                                InputColor: color
                            })
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('å„²å­˜äº‹ä»¶å¤±æ•—');
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('âœ… æ´»å‹•å„²å­˜æˆåŠŸ:', data);
                            calendar.refetchEvents(); // ğŸ”¥ ç¢ºä¿æ–°å¢æ´»å‹•å¾Œé‡æ–°æ•´ç†
                            return eventContent;
                        })
                        .catch(error => {
                            console.error('âŒ å„²å­˜äº‹ä»¶éŒ¯èª¤:', error);
                            Swal.fire('éŒ¯èª¤', 'å„²å­˜äº‹ä»¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', 'error');
                            return false;
                        });
                    } else {
                        Swal.showValidationMessage('è«‹è¼¸å…¥äº‹ä»¶æ¨™é¡Œï¼');
                        return false;
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire('æ´»å‹•å·²æ–°å¢', `å…§å®¹ç‚º: ${result.value}`, 'success');
                }
            });
        },
        events: function(info, successCallback, failureCallback) {
            fetch('/events')
                .then(response => response.json())
                .then(data => {
                    console.log('ğŸ“Œ å¾å¾Œç«¯ç²å–çš„åŸå§‹è³‡æ–™:', data);
                    const events = data.map(event => ({
                        title: event.content,
                        start: event.startdate.split('T')[0],
                        end: new Date(new Date(event.enddate).getTime() + 1000 * 60 * 60 * 24).toISOString().split('T')[0], // ğŸ”¥ ä¿®æ­£ end date
                        color: event.color,
                        allDay: true,
                        id: event.id.toString(),
                    }));
                    successCallback(events);
                })
                .catch(error => {
                    console.error('âŒ è®€å–äº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    failureCallback(error);
                });
        },
        eventClick: function (info) {
            console.log("ğŸ“Œ Event Clicked: ", info);
            const startDate = new Date(info.event.startStr);
            let endDate = new Date(info.event.endStr);
            const correctedEndDate = new Date(endDate.getTime() - 1000 * 60 * 60 * 24);

            Swal.fire({
                title: 'è©³ç´°è³‡è¨Š',
                html: `
                    <p>${info.event.title}</p>
                    <p><strong>é–‹å§‹æ—¥æœŸï¼š</strong>${startDate.toISOString().split('T')[0]}</p>
                    <p><strong>çµæŸæ—¥æœŸï¼š</strong>${correctedEndDate.toISOString().split('T')[0]}</p>
                `,
                icon: 'info',
                confirmButtonText: 'ç¢ºå®š',
                showCancelButton: true,
                cancelButtonText: 'åˆªé™¤æ´»å‹•'
            }).then((result) => {
                if (result.isDismissed) {
                    info.event.remove();
                    fetch(`/events/${info.event.id}`, {
                        method: 'DELETE',
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('åˆªé™¤äº‹ä»¶å¤±æ•—');
                        }
                        return response.json();
                    })
                    .then(() => {
                        Swal.fire('æ´»å‹•å·²åˆªé™¤', '', 'success');
                        calendar.refetchEvents();
                    })
                    .catch(error => {
                        console.error('âŒ åˆªé™¤äº‹ä»¶éŒ¯èª¤:', error);
                        Swal.fire('éŒ¯èª¤', 'åˆªé™¤äº‹ä»¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', 'error');
                    });
                }
            });
        }
    });

    calendar.render();
});
