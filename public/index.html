<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.0/dist/sweetalert2.all.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #calendar {
            max-width: 900px;
            margin: 50px auto;
        }
    </style>
</head>
<body>

    <div id="calendar"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: ''
                },
                events: function(info, successCallback, failureCallback) {
                    //fetch('http://localhost:3000/events')
                    fetch('/events')
                        .then(response => response.json())
                        .then(data => {
                            console.log('從伺服器接收到的資料:', data);
                            const events = data.map(event => {
                                const startDate = new Date(event.startDate);
                                const endDate = new Date(event.endDate);

                                return {
                                    title: event.content,  // 使用 content 作為標題
                                    start: formatDate(startDate),
                                    end: formatDate(endDate),
                                    color: event.color,  // 使用從伺服器返回的顏色
                                    allDay: true,
                                    id: event.id
                                };
                            });

                            console.log('處理後的事件資料:', events);
                            successCallback(events);
                        })
                        .catch(error => {
                            console.error('錯誤:', error);
                            failureCallback(error);
                        });
                },
                selectable: true,
                select: function (info) {
                    const startDate = info.startStr;
                    const CalendarendDate = info.endStr; // 直接使用 FullCalendar 的結束日期
                    const SelectendDate = new Date(new Date(info.endStr).getTime() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];

                    Swal.fire({
                        title: '新增活動',
                        html: `您選擇的範圍：<br><strong>${startDate}</strong> 到 <strong>${SelectendDate}</strong>
                        <br>
                        <label>請選擇顏色：</label><br>
                        <input type="radio" id="red" name="color" value="#FFA500" checked>
                        <label for="red">橘色</label><br>
                        <input type="radio" id="green" name="color" value="#98FF98">
                        <label for="green">綠色</label><br>
                        <input type="radio" id="blue" name="color" value="#89CFF0">
                        <label for="blue">藍色</label><br>
                        `,
                        input: 'text',
                        inputPlaceholder: '請輸入活動內容',
                        showCancelButton: true,
                        confirmButtonText: '確定',
                        cancelButtonText: '取消',
                        preConfirm: function (eventContent) {
                            const color = document.querySelector('input[name="color"]:checked').value; // 取得選擇的顏色
                            if (eventContent) {
                                //return fetch('http://localhost:3000/events', {
                                return fetch('/events', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        InputContent: eventContent,
                                        InputStartDate: startDate,
                                        InputEndDate: CalendarendDate,
                                        InputColor: color  // 傳送顏色資料
                                    })
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('儲存事件失敗');
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    calendar.refetchEvents(); // 重新載入事件
                                    return eventContent;
                                })
                                .catch(error => {
                                    console.error('儲存事件錯誤:', error);
                                    Swal.fire('錯誤', '儲存事件失敗，請稍後再試！', 'error');
                                    return false;
                                });
                            } else {
                                Swal.showValidationMessage('請輸入事件標題！');
                                return false;
                            }
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            Swal.fire('活動已新增', `內容為: ${result.value}`, 'success');
                        }
                    });
                },
                eventClick: function (info) {
                    var startDate = info.event.startStr;
                    var endDate = new Date(info.event.endStr);

                    if (isNaN(endDate.getTime())) {
                        endDate = new Date(info.event.startStr);
                    } else {
                        // 結束日期減去一天
                        endDate.setDate(endDate.getDate() - 1);
                    }

                    Swal.fire({
                        title: '詳細資訊',
                        html: `
                            <p>${info.event.title}</p>
                            <p><strong>開始日期：</strong>${formatDate(new Date(startDate))}</p>
                            <p><strong>結束日期：</strong>${formatDate(endDate)}</p>
                             `,
                        icon: 'info',
                        confirmButtonText: '確定',
                        showCancelButton: true,
                        cancelButtonText: '刪除活動'
                    }).then((result) => {
                        if (result.isDismissed) {
                            // 刪除本地事件
                            info.event.remove();
                            // 刪除伺服器上的事件
                            //fetch(`http://localhost:3000/events/${info.event.id}`, {
                            fetch(`/events/${info.event.id}`, {
                                method: 'DELETE',
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('刪除事件失敗');
                                }
                                return response.json();
                            })
                            .then(() => {
                                Swal.fire('活動已刪除', '', 'success');
                                calendar.refetchEvents(); // 重新載入事件
                            })
                            .catch(error => {
                                console.error('刪除事件錯誤:', error);
                                Swal.fire('錯誤', '刪除事件失敗，請稍後再試！', 'error');
                            });
                        }
                    });
                }
            });

            calendar.render();
        });

        // 格式化日期為 yyyy-MM-dd
        function formatDate(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }
    </script>

</body>
</html>
